#!/usr/bin/env bash
#
# A tool for developing with reproducible virtual machines environments
#

set -euEo pipefail

# CONSTANTS
readonly __VEDV_SCRIPT_NAME="$(basename "${0}")"
readonly __VEDV_DIST_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
readonly __VEDV_COMMANDS_PATH="${__VEDV_DIST_PATH}/lib/vedv/commands"
readonly __VEDV_HYPERVISORS_PATH="${__VEDV_DIST_PATH}/lib/vedv/hypervisors"

# INCLUDE
for f in "${__VEDV_COMMANDS_PATH}/"*.bash; do . "$f"; done

# COMMANDS

# OPTIONS
vedv::__help() {
  cat <<-HELPMSG
Usage:
${__VEDV_SCRIPT_NAME} [OPTIONS] COMMAND

A tool for developing with reproducible virtual machines environments

Options:
  -h, --help                Show this help

Commands:
  cmd1                    it do one thing

Run '${__VEDV_SCRIPT_NAME} COMMAND --help' for more information on a command.
HELPMSG
}

vedv::__on_exit() {
  # shellcheck disable=SC2181
  if [[ $? != 0 ]]; then
    echo
    vedv::__help
  fi
}
# trap vedv::__on_exit INT TERM EXIT

vedv::__run_cmd() {

  local hypervisor=''

  case "${1:-}" in
  vbox)
    shift
    readonly hypervisor='virtualbox'
    ;;
  qemu)
    shift
    readonly hypervisor='qemu'
    ;;
  *)
    readonly hypervisor='virtualbox'
    ;;
  esac

  [[ $# == 0 ]] && set -- '-h'

  if [[ "${1:-}" == @(-h|--help) ]]; then
    vedv::__help
    return 0
  fi

  # include hypervisor
  . "${__VEDV_HYPERVISORS_PATH}/${hypervisor}.bash"

  while [[ $# -gt 0 ]]; do
    case "$1" in
    # OPTIONS
    # COMMANDS
    image)
      shift
      vedv::image::run_cmd "$hypervisor" "$@"
      return $?
      ;;
    container)
      shift
      vedv::container::run_cmd "$hypervisor" "$@"
      return $?
      ;;
    # ERROR
    *)
      echo -e "Invalid parameter: ${1}\n" >&2
      vedv::__help
      return 10
      ;;
    esac
  done
}

vedv::main() {
  vedv::__run_cmd "$@"
}

if [[ "${BASH_SOURCE[0]}" = "${0}" ]]; then
  vedv::main "$@"
  exit $?
fi
