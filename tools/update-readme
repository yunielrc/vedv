#!/usr/bin/env bash
# shellcheck disable=SC2016
#
# Update readme
#
# This script should be executed after each successful test-all run
#

set -eu

export MANJARO_PACKAGES_PROD="$(sed -e '/^##/d' -e '/^$/d' packages-prod-manjaro.versions 2>/dev/null)"
export MANJARO_UNAME_A="${MANJARO_PACKAGES_PROD:+"$(uname -a)"}"
readonly MANJARO_VARS="${MANJARO_PACKAGES_PROD:+"\${MANJARO_UNAME_A} \${MANJARO_PACKAGES_PROD}"}"

export UBUNTU_PACKAGES_PROD="$(sed -e '/^##/d' -e '/^$/d' packages-prod-ubuntu.versions 2>/dev/null)"
export UBUNTU_UNAME_A="${UBUNTU_PACKAGES_PROD:+"$(uname -a)"}"
readonly UBUNTU_VARS="${UBUNTU_PACKAGES_PROD:+"\${UBUNTU_UNAME_A} \${UBUNTU_PACKAGES_PROD}"}"

export VEDV_HELP="$(./dist/usr/bin/vedv --help)"

{
  echo '<!-- DO NOT EDIT THIS FILE; IT WAS GENERATED BY ./tools/update-readme -->'
  echo '<!-- EDIT README.md.tpl INSTEAD -->'

  envsubst "${MANJARO_VARS} ${UBUNTU_VARS} \${VEDV_HELP}" <README.md.tpl
} >README.md

echo '>> README.md was generated successfully, review the changes and commit them'
